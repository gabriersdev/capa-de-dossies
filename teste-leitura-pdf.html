<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  
  <script src="./assets/js/frameworks/pdf.mjs" type="module"></script>
  
  <script type="module">
    /**
    * Retrieves the text of a specif page within a PDF Document obtained through pdf.js 
    * 
    * @param {Integer} pageNum Specifies the number of the page 
    * @param {PDFDocument} PDFDocumentInstance The PDF document obtained 
    **/
    function getPageText(pageNum, PDFDocumentInstance) {
      // Return a Promise that is solved once the text of the page is retrieven
      return new Promise(function (resolve, reject) {
        PDFDocumentInstance.getPage(pageNum).then(function (pdfPage) {
          // The main trick to obtain the text of the PDF page, use the getTextContent method
          pdfPage.getTextContent().then(function (textContent) {
            var textItems = textContent.items;
            var finalString = "";
            
            // Concatenate the string of the item to the final string
            for (var i = 0; i < textItems.length; i++) {
              var item = textItems[i];
              
              finalString += item.str + " ";
            }
            
            // Solve promise with the text retrieven from the page
            resolve(finalString);
          });
        });
      });
    }
    
    // If absolute URL from the remote server is provided, configure the CORS
    // header on that server.
    var url = 'ESPELHO3.pdf';
    
    // Loaded via <script> tag, create shortcut to access PDF.js exports.
      var { pdfjsLib } = globalThis;
      
      // The workerSrc property shall be specified.
      pdfjsLib.GlobalWorkerOptions.workerSrc = './assets/js/frameworks/pdf.worker.mjs';
      
      // Asynchronous download of PDF
      var loadingTask = pdfjsLib.getDocument(url);
      loadingTask.promise.then(function(pdf) {
        console.log('PDF loaded');
        
        var pdfDocument = pdf;
        // Create an array that will contain our promises 
        var pagesPromises = [];
        
        for (var i = 0; i < pdf.numPages; i++) {
          // Required to prevent that i is always the total of pages
          (function (pageNumber) {
            // Store the promise of getPageText that returns the text of a page
            pagesPromises.push(getPageText(pageNumber, pdfDocument));
          })(i + 1);
        }
        
        // Execute all the promises
        Promise.all(pagesPromises).then(function (pagesText) {
          
          // Display text of all the pages in the console
          // e.g ["Text content page 1", "Text content page 2", "Text content page 3" ... ]
          
          if (pagesText.some((p) => p.trim() === '')) {
            console.log('PDF is empty');
          } else {
            
            const sanitizedText = (text) => text.replace(/\s+,/g, ',').replace(/\s+/g, ' ').trim();
            
            const getContent = (text, start, end) => {
              try { 
                return text.search(start) > 0 && text.search(end) > 0 ? text.match(new RegExp(`(${start}).*(${end})`, 'gi')).map((p) => p.replace(new RegExp(`(${start})|(${end})`, 'gi'), '').trim()) : null
              } catch (e) { return []; }
            }
            
            const getContextUsingRegex = (text, regex, regexSanit, index) => {
              try{
                if (!new RegExp(regex).test(text)) return [];
                if (!index) return text.match(new RegExp(regex)).map((p) => p.replace(new RegExp(regexSanit), '').trim());
                else return text.match(new RegExp(regex)).map((p) => p.replace(new RegExp(regexSanit), '').trim())[index];
              } catch (e) {
                return [];
              }
            }
            
            const getAccount = (ret,  index) => {
              if (ret) {
                const account = Array.isArray(ret) ? ret[0].split('-') : ret.split('-');
                return account[index];
              } else {
                return [];
              }
            }
            
            const text = sanitizedText(pagesText.join(' '));
            console.log(text);
            
            try{
              //
            } catch (e) {
              console.error(e);
            }
            
            const data = {
              proponentes: {
                nome: text.match(/(Nome:)\s[\w\s]*\s(Sexo)/gi).map((p) => p.replace(/Nome:|Sexo/gi, '').trim()),
                CPF: text.match(/(CPF:)\s\d{3}\.\d{3}\.\d{3}-\d{2}\s(Nome)/gi).map((p) => p.replace(/(CPF:)|Nome/gi, '').trim())
              },
              modalidade: text.match(/(Negociada Item de Produto: \d{1,} -)(\s\w+\s)/gi)[0].replace(/(Negociada Item de Produto: \d{1,} -)|\s/gi, '').trim(),
              contrato: getContextUsingRegex(text, /(Número Contrato para Administração:)\s\d{1}\.\d{4}\.\d{7}-\d{1}\s*Situação/gi, /(Número Contrato para Administração:)|Situação/gi),
              endereco: getContent(text, 'Endereço da Unidade Habitacional:', 'Vagas'),
              empreendimento: getContent(text, 'Nome do Empreendimento:', 'Tipo de Unidade'),
              valores: {
                compra_e_venda: getContent(text, 'Valor Compra e Venda ou Orçamento Proposto pelo Cliente:', 'Valor Financiamento Negociado'),
                finaciamento: getContent(text, 'Valor Financiamento Negociado:', 'Cota de Financiamento Calculada') || '0,00',
                recursos_proprios: getContent(text, 'Valor Recursos Próprios Aportados:', 'Valor Recursos Próprios') || '0,00',
                FGTS: getContent(text, 'Valor Total Utilizado FGTS:', 'Valor FMP:') || '0,00',
                subsidio: getContent(text, 'Subsídio Complemento Capacidade Financeira:', 'Valor Operação') || '0,00',
                taxas_de_cartorio: getContent(text, 'Valor das Taxas Financiadas:', 'Taxas à vista') || '0,00',
              },
              // Conta para débito das parcelas
              conta_debito: {
                banco: '104',
                agencia: getAccount(getContextUsingRegex(text, /(Conta para Débito:)\s(\d{4}-\d{3,4}-\d{12}-\d{1})\s(Débito em Conta)/gi, /(Conta para Débito:)|(Débito em Conta)/gi), 0),
                operacao: getAccount(getContextUsingRegex(text, /(Conta para Débito:)\s(\d{4}-\d{3,4}-\d{12}-\d{1})\s(Débito em Conta)/gi, /(Conta para Débito:)|(Débito em Conta)/gi), 1),
                conta: getAccount(getContextUsingRegex(text, /(Conta para Débito:)\s(\d{4}-\d{3,4}-\d{12}-\d{1})\s(Débito em Conta)/gi, /(Conta para Débito:)|(Débito em Conta)/gi), 2),
                digito: getAccount(getContextUsingRegex(text, /(Conta para Débito:)\s(\d{4}-\d{3,4}-\d{12}-\d{1})\s(Débito em Conta)/gi, /(Conta para Débito:)|(Débito em Conta)/gi), 3),
              },
              // Apenas no caso de vendedor e processo individual
              conta_deposito: {
                banco: getAccount(getContextUsingRegex(text, /(Conta para Crédito:)\s(\d{3}-\d{4}-\d{3,4}-\d{12}-\d{1})\s(Conta para Débito)/gi, /(Conta para Crédito:)|(Conta para Débito)/gi), 0),
                agencia: getAccount(getContextUsingRegex(text, /(Conta para Crédito:)\s(\d{3}-\d{4}-\d{3,4}-\d{12}-\d{1})\s(Conta para Débito)/gi, /(Conta para Crédito:)|(Conta para Débito)/gi), 1),
                operacao: getAccount(getContextUsingRegex(text, /(Conta para Crédito:)\s(\d{3}-\d{4}-\d{3,4}-\d{12}-\d{1})\s(Conta para Débito)/gi, /(Conta para Crédito:)|(Conta para Débito)/gi), 2),
                conta: getAccount(getContextUsingRegex(text, /(Conta para Crédito:)\s(\d{3}-\d{4}-\d{3,4}-\d{12}-\d{1})\s(Conta para Débito)/gi, /(Conta para Crédito:)|(Conta para Débito)/gi), 3),
                digito: getAccount(getContextUsingRegex(text, /(Conta para Crédito:)\s(\d{3}-\d{4}-\d{3,4}-\d{12}-\d{1})\s(Conta para Débito)/gi, /(Conta para Crédito:)|(Conta para Débito)/gi), 4),
              },
            }
            
            document.write(JSON.stringify(data, null, 2));
          }
          
        });
        
      }, function (reason) {
        // PDF loading error
        console.error(reason);
      });
    </script>
    
    <h1>Using PDF.js</h1>
    
    <canvas id="the-canvas"></canvas>
    
  </body>
  </html>